sequenceDiagram
    actor ğŸ‘¤ User
    participant ğŸ“± Client App
    participant ğŸŒ Browser
    participant ğŸ” OAuth Server
    participant ğŸ’¾ Database

    %% Phase 1: Initiate Login
    ğŸ‘¤ User->>ğŸ“± Client App: Click "Login"
    ğŸ“± Client App->>ğŸŒ Browser: Redirect to /authorize + PKCE challenge
    
    %% Phase 2: User Authentication
    ğŸŒ Browser->>ğŸ” OAuth Server: GET /authorize
    ğŸ” OAuth Server->>ğŸŒ Browser: Show login page
    ğŸ‘¤ User->>ğŸŒ Browser: Enter credentials
    ğŸŒ Browser->>ğŸ” OAuth Server: POST /login
    ğŸ” OAuth Server->>ğŸ’¾ Database: Validate user
    ğŸ’¾ Database-->>ğŸ” OAuth Server: User valid
    ğŸ” OAuth Server->>ğŸŒ Browser: Set session + show consent
    
    %% Phase 3: User Consent
    ğŸ‘¤ User->>ğŸŒ Browser: Click "Allow"
    ğŸŒ Browser->>ğŸ” OAuth Server: POST /authorize (consent)
    ğŸ” OAuth Server->>ğŸ’¾ Database: Store auth code + PKCE
    ğŸ” OAuth Server->>ğŸŒ Browser: Redirect with auth code
    
    %% Phase 4: Token Exchange
    ğŸŒ Browser->>ğŸ“± Client App: Deliver auth code
    ğŸ“± Client App->>ğŸ” OAuth Server: POST /token (code + PKCE verifier)
    ğŸ” OAuth Server->>ğŸ’¾ Database: Validate code + PKCE
    ğŸ’¾ Database-->>ğŸ” OAuth Server: Valid
    ğŸ” OAuth Server->>ğŸ’¾ Database: Store refresh token
    ğŸ” OAuth Server-->>ğŸ“± Client App: Return access + refresh tokens
    ğŸ“± Client App-->>ğŸ‘¤ User: Login successful
