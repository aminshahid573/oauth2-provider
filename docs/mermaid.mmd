sequenceDiagram
    actor 👤 User
    participant 📱 Client App
    participant 🌐 Browser
    participant 🔐 OAuth Server
    participant 💾 Database

    %% Phase 1: Initiate Login
    👤 User->>📱 Client App: Click "Login"
    📱 Client App->>🌐 Browser: Redirect to /authorize + PKCE challenge
    
    %% Phase 2: User Authentication
    🌐 Browser->>🔐 OAuth Server: GET /authorize
    🔐 OAuth Server->>🌐 Browser: Show login page
    👤 User->>🌐 Browser: Enter credentials
    🌐 Browser->>🔐 OAuth Server: POST /login
    🔐 OAuth Server->>💾 Database: Validate user
    💾 Database-->>🔐 OAuth Server: User valid
    🔐 OAuth Server->>🌐 Browser: Set session + show consent
    
    %% Phase 3: User Consent
    👤 User->>🌐 Browser: Click "Allow"
    🌐 Browser->>🔐 OAuth Server: POST /authorize (consent)
    🔐 OAuth Server->>💾 Database: Store auth code + PKCE
    🔐 OAuth Server->>🌐 Browser: Redirect with auth code
    
    %% Phase 4: Token Exchange
    🌐 Browser->>📱 Client App: Deliver auth code
    📱 Client App->>🔐 OAuth Server: POST /token (code + PKCE verifier)
    🔐 OAuth Server->>💾 Database: Validate code + PKCE
    💾 Database-->>🔐 OAuth Server: Valid
    🔐 OAuth Server->>💾 Database: Store refresh token
    🔐 OAuth Server-->>📱 Client App: Return access + refresh tokens
    📱 Client App-->>👤 User: Login successful
