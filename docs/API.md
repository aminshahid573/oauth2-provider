# API Reference Guide

This document provides a complete technical reference for all machine-to-machine (M2M) and administrative API endpoints of the OAuth2 Provider. It is intended for developers building client applications or managing the service.

## Common Conventions

### Base URL
All endpoint paths in this document are relative to the server's base URL. For local development, this is `http://localhost:8080`.

### Authentication Methods
Different endpoints require different authentication methods:
- **Client Authentication**: Used by client applications to authenticate themselves (not a user). This is typically done via `client_id` and `client_secret` sent in the request body or as an HTTP Basic Auth header.
- **Bearer Token**: Used by clients to access protected resources (like the UserInfo endpoint) on behalf of a user. The token is sent in the `Authorization` header: `Authorization: Bearer <access_token>`.
- **Session Cookie**: Used by the browser-based Admin UI to authenticate administrative users. Requests must include the `session_id` cookie.

### Error Responses
API errors (for endpoints returning JSON) follow the standard OAuth2 format:
```json
{
  "error": "invalid_request",
  "error_description": "The request is missing a required parameter."
}
```

---

## Category 1: Core OAuth2 API Endpoints

These endpoints are the primary interface for client applications implementing OAuth2 flows.

### Endpoint: `POST /oauth2/token`

This is the central endpoint for all flows that issue tokens.
- **Content-Type**: `application/x-www-form-urlencoded`

---
#### Grant Type: `authorization_code`
Exchanges an authorization code (obtained from a user-facing flow) for tokens.

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `grant_type` | **Yes** | Must be `authorization_code`. |
| `code` | **Yes** | The authorization code from the `/authorize` redirect. |
| `redirect_uri` | **Yes** | Must exactly match the `redirect_uri` used in the initial `/authorize` request. |
| `client_id` | **Yes** | The client's unique identifier. |
| `client_secret` | **Yes** | The client's secret. |
| `code_verifier` | If PKCE | The PKCE secret generated by the client at the start of the flow. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/token \
-d "grant_type=authorization_code" \
-d "code=SplxlOBeZQQYbYS6WxSbIA" \
-d "redirect_uri=http://localhost:3000/callback" \
-d "client_id=test-client" \
-d "client_secret=test-secret" \
-d "code_verifier=a_very_long_random_string_generated_by_client"
```

**Success Response (`200 OK`):**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6Im...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "a_very_long_and_secure_refresh_token_string...",
  "scope": "openid profile"
}
```

---
#### Grant Type: `client_credentials`
For server-to-server authentication where a client accesses its own resources.

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `grant_type` | **Yes** | Must be `client_credentials`. |
| `client_id` | **Yes** | The client's ID. |
| `client_secret` | **Yes** | The client's secret. |
| `scope` | No | A space-delimited list of scopes. If omitted, the client's default scopes are used. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/token \
-d "grant_type=client_credentials" \
-d "client_id=m2m-client" \
-d "client_secret=m2m-secret" \
-d "scope=api:read"
```

**Success Response (`200 OK`):**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6Im...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "api:read"
}
```

---
#### Grant Type: `refresh_token`
Obtains a new access token using a long-lived refresh token.

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `grant_type` | **Yes** | Must be `refresh_token`. |
| `refresh_token` | **Yes** | The refresh token obtained from a previous flow. |
| `client_id` | **Yes** | The client's ID. |
| `client_secret` | **Yes** | The client's secret. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/token \
-d "grant_type=refresh_token" \
-d "refresh_token=a_very_long_and_secure_refresh_token_string..." \
-d "client_id=test-client" \
-d "client_secret=test-secret"
```

**Success Response (`200 OK`):**
```json
{
  "access_token": "a_new_access_token_jwt...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "openid profile"
}
```

---
#### Grant Type: `urn:ietf:params:oauth:grant-type:device_code`
Used by input-constrained devices to poll for tokens.

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `grant_type` | **Yes** | Must be `urn:ietf:params:oauth:grant-type:device_code`. |
| `device_code` | **Yes** | The `device_code` obtained from the `/device_authorization` endpoint. |
| `client_id` | **Yes** | The client's ID. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/token \
-d "grant_type=urn:ietf:params:oauth:grant-type:device_code" \
-d "device_code=long_secret_for_device" \
-d "client_id=test-client"
```

**Pending Response (`400 Bad Request`):**
```json
{
  "error": "authorization_pending",
  "error_description": "User has not yet approved the request."
}
```

**Success Response (`200 OK`):**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6Im...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "refresh_token": "a_very_long_and_secure_refresh_token_string...",
  "scope": "openid profile"
}
```

---
#### Grant Type: `urn:ietf:params:oauth:grant-type:jwt-bearer`
For high-security server-to-server authentication using a signed JWT.

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `grant_type` | **Yes** | Must be `urn:ietf:params:oauth:grant-type:jwt-bearer`. |
| `assertion` | **Yes** | A JWT signed by the client's private key. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/token \
-d "grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer" \
-d "assertion=eyJhbGciOiJSUzI1NiIsImtpZCI6Im..."
```

**Success Response (`200 OK`):**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsImtpZCI6Im...",
  "token_type": "Bearer",
  "expires_in": 3600,
  "scope": "api:read api:write"
}
```

---
### Endpoint: `POST /oauth2/device_authorization`
Starts the Device Authorization Flow.

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `client_id` | **Yes** | The client's ID. |
| `scope` | No | A space-delimited list of scopes. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/device_authorization \
-d "client_id=test-client" \
-d "scope=openid profile"
```

**Success Response (`200 OK`):**
```json
{
  "device_code": "a_long_secret_string_for_the_device",
  "user_code": "ABCDEFGH",
  "verification_uri": "http://localhost:8080/device",
  "expires_in": 900,
  "interval": 5
}
```

---
### Endpoint: `POST /oauth2/introspect`
Allows a resource server to validate an access token.

- **Authentication**: HTTP Basic Auth (`-u client_id:client_secret`).

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `token` | **Yes** | The access token to validate. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/introspect \
-u "resource-server:resource-server-secret" \
-d "token=eyJhbGciOiJSUzI1NiIsImtpZCI6Im..."
```

**Success Response (`200 OK`, Active Token):**
```json
{
  "active": true,
  "scope": "openid profile",
  "client_id": "test-client",
  "sub": "6675d3a...",
  "exp": 1755855000,
  "iat": 1755854100,
  "token_type": "Bearer"
}
```

**Success Response (`200 OK`, Inactive Token):**
```json
{
  "active": false
}
```

---
### Endpoint: `POST /oauth2/revoke`
Invalidates a refresh token.

- **Authentication**: HTTP Basic Auth (`-u client_id:client_secret`).

**Request Body:**
| Parameter | Required | Description |
|---|---|---|
| `token` | **Yes** | The `refresh_token` to revoke. |

**Example Request:**
```bash
curl -X POST http://localhost:8080/oauth2/revoke \
-u "test-client:test-secret" \
-d "token=a_very_long_and_secure_refresh_token_string..."
```

**Success Response (`200 OK`):**
An empty body.

---
### Endpoint: `GET /oauth2/userinfo`
Retrieves information about the user associated with an access token.

- **Authentication**: Bearer Token (`Authorization: Bearer <access_token>`).

**Example Request:**
```bash
curl -H "Authorization: Bearer eyJhbGciOiJSUzI1NiIsImtpZCI6Im..." \
http://localhost:8080/oauth2/userinfo
```

**Success Response (`200 OK`):**
```json
{
  "sub": "6675d3a...",
  "name": "testuser",
  "preferred_username": "testuser",
  "email": "testuser@example.com",
  "email_verified": false
}
```

---
## Category 2: Admin API Endpoints

These endpoints are for managing the OAuth2 provider itself and are protected by an admin user's session.

- **Authentication**: Session Cookie (`Cookie: session_id=...`).
- **CSRF Protection**: All `POST`, `PUT`, `DELETE` requests require an `X-CSRF-Token` header.

### Endpoint: `GET /api/admin/clients`
Lists all registered client applications.

**Example Request:**
```bash
curl -H "Cookie: session_id=your_admin_session_cookie" \
http://localhost:8080/api/admin/clients
```

**Success Response (`200 OK`):**
```json
[
  {
    "client_id": "test-client",
    "name": "My Awesome App",
    "redirect_uris": ["http://localhost:3000/callback"],
    "grant_types": ["authorization_code", "refresh_token"],
    "response_types": ["code"],
    "scopes": ["openid", "profile"]
  }
]
```

### Endpoint: `POST /api/admin/clients`
Creates a new client application.

**Request Body (`application/json`):**
```json
{
    "name": "New API Client",
    "redirect_uris": ["https://example.com/callback"],
    "grant_types": ["authorization_code"],
    "response_types": ["code"],
    "scopes": ["openid"]
}
```

**Success Response (`201 Created`):**
```json
{
  "client_id": "a_newly_generated_id",
  "client_secret": "a_one_time_plaintext_secret",
  "name": "New API Client",
  "redirect_uris": ["https://example.com/callback"],
  "grant_types": ["authorization_code"],
  "response_types": ["code"],
  "scopes": ["openid"]
}
```
*(Note: Other admin endpoints for clients and users follow a similar CRUD pattern.)*

---
| [![Previous](https://img.shields.io/badge/←_Previous-1f6feb?style=for-the-badge&logo=none&logoColor=white&labelColor=1f6feb&color=1f6feb)](ARCHITECTURE.md) <br> <sub>ARCHITECTURE.md</sub> | [![Next](https://img.shields.io/badge/Next_→-1f6feb?style=for-the-badge&logo=none&logoColor=white&labelColor=1f6feb&color=1f6feb)](FLOWS.md) <br> <sub>FLOWS.md</sub> |
|----------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------|
